#!/bin/bash
# Insert the stylesheet into the email.

### Derive filterInsertSheet.
# Look for "<head>" (or similar). Replace it with "<head>" followed by code to insert the stylesheet. There are some comments inserted as well to make it easier to update the inserted code, or even remove it in the future.
filterInsertSheet="s/<head><!-- Inserted stylesheet using kmailMessageDarkMode.*END OF kmailMessageDarkMode -->/<head>/g;s#<[hH][eE][aA][dD]>#<head><!-- Inserted stylesheet using kmailMessageDarkMode at $(date) --><link rel=\"stylesheet\" href=\"/var/lib/kmailMessageDarkMode/custom.css\"><!-- END OF kmailMessageDarkMode -->#g"



### Derive filterCleanColour.
# This is the hard bit, because we have to cope with all the inconsistency that has ever been conceived in hard-coding colours.
# As it currently is. The following not currently be undone A work around could be to replace these with non-existent attributes. Eg "color=" -> "disabledColor=". I haven't yet tested whether this will silently fail, and be fine. Or this will create more problems than it will solve.
# color:#000000;background-color:#FFFFFF

# Fix new lines so that the following patterns won't get broken and fail to match.
fixNewLines=':a;$!{N;s/([^?])=\n([^M][^I][^M][^E])/\1\2/;ba;}'

# Make bgcolor the same as color, then remove it. The first step saves duplication. 
reduceTheStuffWeNeedToMatch="s/\\(bgcolor\\|background-color\\|background\\)/color/g"

# What sorts of colours we look for. Eg #9999FF, bright-blue etc.
colorRepresentation="\\(#......\\|[A-Za-z]\\([A-Za-z]*-*\\)*\\)"

# CSS format.
cssBased="s/color *: *$colorRepresentation//g"

# HTML format.
htmlBased="s/color *= *\\(\"\\|'\\)*${colorRepresentation}\\(\"\\|'\\)*//g"

# Bring it together.
stuffWeNeedToMatch="$cssBased;$htmlBased"
filterCleanColour="$reduceTheStuffWeNeedToMatch;$stuffWeNeedToMatch"



### Derive filterAll.
# Combine everything together for the "all" option.
filterAll="${filterInsertSheet};${filterCleanColour}"



### Get on to normal flow.
# Default to all.
filterMethod='all'

# Load the user config if we have one.
if [ -e ~/.config/kmailMessageDarkModerc ]; then
    . ~/.config/kmailMessageDarkModerc
fi

# Override if there is an environment variable set. This is primarily intended for testing.
if [ "$FILTER_METHOD" != '' ]; then
    filterMethod="$FILTER_METHOD"
fi

# Get the selected filter.
shouldFixNewLines="false"
case "$filterMethod" in
    'insertSheet')
        filter="$filterInsertSheet"
    ;;
    'cleanColour')
        filter="$filterCleanColour"
        shouldFixNewLines="true"
    ;;
    'all')
        filter="$filterAll"
        shouldFixNewLines="true"
    ;;
    *)
        filter="$filterAll"
        shouldFixNewLines="true"
    ;;
esac

# Run the filter only if it is not disabled.
if [ "$filterMethod" != 'disable' ]; then
    if [ "$shouldFixNewLines" == 'true' ]; then
        sed "s/=3D/=/g;" | sed -E "$fixNewLines" | sed "$filter"
    else
        sed "$filter"
    fi
fi
